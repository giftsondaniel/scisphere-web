var color;
var menuData;
var snapshotKeyArray=[];
var rateById = d3.map();
var border = 2;
var bordercolor = 'rgb(205,201,201)';
var width = 420,
    height = 450,
    centered;
var margin = {top: 20, right: 120, bottom: 20, left: 120};


var sub_list,level0Data,level1Data,levelsData;
function isInteger(x) {
    return x % 1 === 0;
}

window.onload = function(){
   $('#fieldDetails').html("Loading Data...");

   //$("#from_time_id").data("selectBox-selectBoxIt").remove();
   //$("#to_time_id").data("selectBox-selectBoxIt").remove();

   d3.json("/app/subscription_list",function(data){
	sub_list = data;


     /* Function for pushing values to hash params */
	function push_values_to_hash_params(){
		var level0Val="";
		var level1Val="";
		var my_build_url="";
		if(sub_list["plus_plans"].length > 0){
			level0Val = sub_list['free_plans']['country'];
			level1Val = sub_list['plus_plans'][0];
		}else{
			level0Val = sub_list['free_plans']['country'];
			level1Val = sub_list['free_plans']['state'];
		}

		selectedVariable = ['IND_PCA_01', 'IND_PCA_21', 'IND_PCA_23'];
		var pathname1 = window.location.pathname;
		var prmsDt = $.deparam.fragment();
		var prms ={level0:level0Val, level1:level1Val, level:2, field:selectedVariable[0], year:'2011' };//,selected: selectedid }
		var r =$.param.fragment(pathname1, prms, 2 );
		var prms1 = $.deparam.fragment();
		if(Object.keys(prms1).length > 0){}else{  $.bbq.pushState(r);}
		//$.bbq.pushState(r);

	
	}/* end of pushing values to hash params*/



     d3.json("/app/scisphere/places/countries" , function(data) {

	d3.json('/app/mysphere_mybuilds_for_region_snapshot_list/33',function(data){

		/*check if data in MY Builds for a user*/
		if((data.MyBuild.length > 0)){
			var str = JSON.stringify(data.MyBuild[0])
			var newvar = JSON.parse(str);
			selectedVariable = (JSON.parse(newvar)['variable']);
			selectedMyVariable = (JSON.parse(newvar)['selectedMyVariable']);

			if(JSON.parse(newvar).region != ''){ /*check if data has regions values in MY Builds for a user*/
				var region = JSON.parse(newvar)['region'];
				if(JSON.parse(newvar)['level']){   /*check if levels are available in MY Builds for a user*/

					//Load on change of region locations in another page of explore:
					var level0Val = JSON.parse(newvar)['level']['level_0'];
					var level1Val = JSON.parse(newvar)['level']['level_1'];
					var sub_list_not_in_level1 = 0;
					if(sub_list["plus_plans"].length > 0){
					    if(level1Val){	
						for(var i = 0; i<sub_list["plus_plans"].length; i++){
						    if(level1Val ==sub_list["plus_plans"][i] ){
							sub_list_not_in_level1 = 1;
						    }
						}
					    }	
					}	
			
					if((level0Val==region['level_0']) && (level1Val==region['level_1']) && (sub_list_not_in_level1 == 1)){	/*check if country and state in MY Builds for a user*/
						var pathname1 = window.location.pathname;
						var prmsDt = $.deparam.fragment();
						if($.inArray(region['region_key'], selectedVariable)!= -1){
							var prms ={level0:region['level_0'], level1:region['level_1'], level:region['level'], field:region['region_key'], year:'2011' };
						}else{
							var prms ={level0:region['level_0'], level1:region['level_1'], level:region['level'], field:selectedVariable[0], year:'2011' };
						}
							var r =$.param.fragment(pathname1 ,prms, 2 );
						//$.bbq.pushState(r);
						var prms1 = $.deparam.fragment();
						if(Object.keys(prms1).length > 0){}else{  $.bbq.pushState(r);}
					} else if((sub_list_not_in_level1 == 1)) {
						var pathname1 = window.location.pathname;
						var prmsDt = $.deparam.fragment();
						if($.inArray(region['region_key'], selectedVariable)!= -1){
							var prms ={level0:level0Val, level1:level1Val, level:2, field:selectedVariable[0], year:'2011' };//,selected: selectedid }	
						}else{
							var prms ={level0:level0Val, level1:level1Val, level:2, field:selectedVariable[0], year:'2011' };//,selected: selectedid }
						}
						var r =$.param.fragment(pathname1 ,prms, 2 );
						//$.bbq.pushState(r);
						var prms1 = $.deparam.fragment();
						if(Object.keys(prms1).length > 0){}else{  $.bbq.pushState(r);}
					} else {
						push_values_to_hash_params();
					}
				} else {
					push_values_to_hash_params();
				}
			} else {
				push_values_to_hash_params();
			}
		} else {
			push_values_to_hash_params();
		}
	});

	//Working for country
	level0Data = data;
	var level0Id = document.getElementById('level_0_Id');
	for(var i=0;i<level0Data.length;i++){
		var optlevel0 = document.createElement('option');
		var valCh = level0Data[i].name_0;
		var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		optlevel0.innerHTML = valCam;
		optlevel0.value = level0Data[i].id_0;
		level0Id.appendChild(optlevel0);
	}


	$('.custom_selectbox').selectBoxIt();
	$('#level_0_Id').selectBoxIt();	

	//$("#from_time_id").selectBoxIt({ defaultText: '', autoWidth: false });	
	//$("#to_time_id").selectBoxIt({ defaultText: '', autoWidth: false });	

	d3.select("#menu-div").style('display','block');

	// Hash Params
	var prms = $.deparam.fragment()
	if(Object.keys(prms).length > 0){
	    hashParams();
	}	
	// Hash Params	

	//HashChange
	$(window).bind( "hashchange", function(e) {
	    var prms = $.deparam.fragment()
	    if(Object.keys(prms).length > 0){
		hashParams();
	    }
	});
	//HashChange

   });
   });
}


function level0Change(){
   snapshotKeyArray=[];
   var filterLevel0Id = document.getElementById("level_0_Id").value;
   d3.json("/app/scisphere/places/countrydetail?level0="+filterLevel0Id+"" , function(data) {

	hashflag1=0;
	$("#level_1_Id").data("selectBox-selectBoxIt").remove();
	$("#levelId").data("selectBox-selectBoxIt").remove();
        variableCategory = data["keys"];
	myVariables = data["myvariables"];
	removeSVG();
	//level1 load
	menuData = data;
	var level1Id = document.getElementById('level_1_Id');
	var yearId = document.getElementById("yearId")
	if(!data.levels){
		$("#levelId").html("");
		$("#yearId").html("");
		return false;
	}
	levelsData = data.levels;
	level1Data = data.level1;
	var keysData = data.keys;

	for(var key in levelsData){
		if(key == filterLevel0Id){
		var optlevel1 = document.createElement('option');
		var valCh = levelsData[key].level1;
		var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		optlevel1.innerHTML = "Select "+valCam;
		optlevel1.value = 0;
		optlevel1.setAttribute("selected", "selected");
		optlevel1.setAttribute("disabled", "disabled");
		level1Id.appendChild(optlevel1);
		break;
		}
	}
	for(var key in level1Data) {
		if(key == filterLevel0Id){
			//sorting
			var level1list = level1Data[key];
			var sortable = [];
			for (var vehicle in level1list)
			      sortable.push([vehicle, level1list[vehicle]])
			sortable.sort(function(a,b) { return d3.ascending(a[1],b[1]); });
			//sorting
			if(sub_list['plus_plans'].length > 0){
				for(var i=0;i<sortable.length;i++){
					if(( $.inArray(sortable[i][0], sub_list['plus_plans']) != -1)){
						var optlevel1 = document.createElement('option');
						var valCh = sortable[i][1];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel1.innerHTML = valCam;
						optlevel1.value = sortable[i][0];
						level1Id.appendChild(optlevel1);
					}
				}
			}else{
				for(var i=0;i<sortable.length;i++){
					if( sortable[i][0]=== sub_list['free_plans']['state'][0]){
						var optlevel1 = document.createElement('option');
						var valCh = sortable[i][1];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel1.innerHTML = valCam;
						optlevel1.value = sortable[i][0];
						level1Id.appendChild(optlevel1);
					}
				}
			}
		break;
		}
	}
	$("#level_1_Id").data("selectBox-selectBoxIt").add();
	// levels load
	for(var key in levelsData){
		var levelName='';
		if(key == filterLevel0Id){
			//for(var i=2; i<Object.keys(levelsData[key]).length; i++){ // i=2 - level2 starting from 2 
			for(var i=2; i<4; i++){ // i=2 - level2 starting from 2 
				if(levelsData[key]["level"+i+""]){
					if(levelsData[key]["level"+i+""] instanceof Array){
						for(var j=0; j<levelsData[key]["level"+i+""].length; j++){
							var optlevel = document.createElement('option');
							var valCh = levelsData[key]["level"+i+""][j];
							var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
							optlevel.innerHTML = "Display "+valCam+" Level";
							optlevel.value = i+"."+j;
							levelId.appendChild(optlevel);
						}
					}else{
						var optlevel = document.createElement('option');
						var valCh = levelsData[key]["level"+i+""];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel.innerHTML = "Display "+valCam+" Level";
						optlevel.value = i;
						levelId.appendChild(optlevel);
					}
				}
			}
			break;
		}
	}
	// year load
	var optyear = document.createElement('option');
	optyear.innerHTML = 2011;
	optyear.value = 2011;
	yearId.appendChild(optyear);

	var yearval = document.getElementById("yearId").value;
	$('#levelId').data("selectBox-selectBoxIt").add();
	$('#yearId').data("selectBox-selectBoxIt").add();
	loadVariableCategory();
   });

}

//hashparams call
function hashParams(){

	//$("#level_1_Id").data("selectBox-selectBoxIt").remove();
	//$("#levelId").data("selectBox-selectBoxIt").remove();
	hashflag1=1;
	// Url Param Load Function
	var prms = $.deparam.fragment();

	if(Object.keys(prms).length > 0){
		var level0_Id = prms.level0;
		var level1_Id = prms.level1;
		var levelid = prms.level;
 		var fieldid = prms.field;
		var selectedid = prms.selected;
		var level2;
		var level2=[];

		if(sub_list['plus_plans'].length == 0){
			
		    //if((fieldid != "IND_PCA_01" ) || (fieldid != "IND_PCA_21" ) || (fieldid != "IND_PCA_23")){
		    if(!( $.inArray(fieldid, selectedVariable) > -1)) {
			
			selectedVariable = ['IND_PCA_01', 'IND_PCA_21', 'IND_PCA_23'];
			bootbox.dialog({
			  message: "You do not currently have access to these variables. To access them you will have to upgrade your plan. Upgrade now?",
			  buttons: {
			    no: {
			      label: "No Thank You."
			    },
			    yes: {
			      label: "Yes Please.",
			      callback: function() {
				window.location="/app/upgrade_account";
			      }
			    }
			  }
			});

			var pathname1 = window.location.pathname;
			var prmsDt = $.deparam.fragment();
			var prms ={field:'IND_PCA_01'};
			var r =$.param.fragment(pathname1,prms,2 );
			$.bbq.pushState(r);
			var prms1 = $.deparam.fragment();
		    }
		}

		// country load
		document.getElementById('level_0_Id').value = level0_Id;
		//$("#level0Id option[value="+level0Val+"]").attr('selected', 'selected');
		$("#level_0_Id").data("selectBox-selectBoxIt").add();


		// state load
		var filterLevel0Id = document.getElementById("level_0_Id").value;
		if(menuData){
			setMenuData();
			loadData();
		}else{
		
			d3.json("/app/scisphere/places/countrydetail?level0="+filterLevel0Id+"" , function(data) {

				if(selectedMyVariable.length == 0){
					if(templatename){
						if(data["myvariables"]){
							selectedMyVariable = []
							selectedMyVariable.push(data["myvariables"][templatename]['levelsmapping']['level2'][0]);
							selectedMyVariable.push(data["myvariables"][templatename]['levelsmapping']['level2'][1]);
							selectedMyVariable.push(data["myvariables"][templatename]['levelsmapping']['level3'][0]);
							selectedMyVariable.push(data["myvariables"][templatename]['levelsmapping']['level3'][1]);
						}
					}
				}

				document.getElementById('fieldDetails').innerHTML="";
				variableCategory = data["keys"];
				myVariables = data["myvariables"];
				level1Data = data.level1;
				menuData = data;
				loadVariableCategory();
				setMenuData();
				//selectedMyVariableProd = ["pv_16_3", "pv_18_13"];
				applySelectedVariable();

				loadData();

				var selectedMyVariableId = fieldid.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/g, '_');
				var re = new RegExp(" ", 'g');
				selectedMyVariableId = selectedMyVariableId.replace(re, '_');
				d3.select("#"+fieldid).attr('class','selected');
			});
		}
	
	}
}


var variableCategory,myVariables,units,description='';
var selectedGeoState=[]
var variableTotalPage=1;
var selectedVariable = ['IND_PCA_01', 'IND_PCA_21', 'IND_PCA_23'];
var keyParameterArr=[];

function setMenuData(){

	keyParameterArr=[];
	snapshotKeyArray=[];

	$("#level_1_Id").data("selectBox-selectBoxIt").remove();
	$("#levelId").data("selectBox-selectBoxIt").remove();

	hashflag1=1;
	// Url Param Load Function
	var prms = $.deparam.fragment();

	if(Object.keys(prms).length > 0){
	var level0_Id = prms.level0;
	var level1_Id = prms.level1;
	var levelid = prms.level;
	var yearid = prms.year;
	fieldval = prms.field;
	var selectedid = prms.selected;
	var filtercountry = document.getElementById("level_0_Id").value;
	var level1Id = document.getElementById('level_1_Id');
	levelsData = menuData.levels;
	var level1Data = menuData.level1;
	var keysData = menuData.keys;
	//state load
	for(var key in levelsData){
		if(key == filtercountry){
		var optlevel1 = document.createElement('option');
		var valCh = levelsData[key].level1;
		var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		optlevel1.innerHTML = "Select "+valCam;
		optlevel1.value = 0;
		optlevel1.setAttribute("disabled", "disabled");
		level1Id.appendChild(optlevel1);
		break;
		}
	}
	for(var key in level1Data) {
		if(key == filtercountry){
			//sorting
			var level1list = level1Data[key];
			var sortable = [];
			for (var vehicle in level1list)
			      sortable.push([vehicle, level1list[vehicle]])
			sortable.sort(function(a,b) { return d3.ascending(a[1],b[1]); });
			//sorting
			/*for(var i=0;i<sortable.length;i++){
				if(( $.inArray(sortable[i][0], sub_list['all_plans']) != -1)){
					var optlevel1 = document.createElement('option');
					var valCh = sortable[i][1];
					var valCam = valCh.replace(/\w\S* /g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
					optlevel1.innerHTML = valCam;
					optlevel1.value = sortable[i][0];
					level1Id.appendChild(optlevel1);
				}
			}*/
			if(sub_list['plus_plans'].length > 0){
				for(var i=0;i<sortable.length;i++){
					if(( $.inArray(sortable[i][0], sub_list['plus_plans']) != -1)){
						var optlevel1 = document.createElement('option');
						var valCh = sortable[i][1];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel1.innerHTML = valCam;
						optlevel1.value = sortable[i][0];
						level1Id.appendChild(optlevel1);
					}
				}
			}else{
				for(var i=0;i<sortable.length;i++){
					if(sortable[i][0] === sub_list['free_plans']['state'][0]){
						var optlevel1 = document.createElement('option');
						var valCh = sortable[i][1];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel1.innerHTML = valCam;
						optlevel1.value = sortable[i][0];
						level1Id.appendChild(optlevel1);
					}
				}
			}
		break;
		}
	}

	// levels load
	
	for(var key in levelsData){
		var levelName='';
		if(key == filtercountry){
			for(var i=2; i<4; i++){ // i=2 - level2 starting from 2 
				if(levelsData[key]["level"+i+""]){
					if(levelsData[key]["level"+i+""] instanceof Array){
							for(var j=0; j<levelsData[key]["level"+i+""].length; j++){
							var optlevel = document.createElement('option');
							var valCh = levelsData[key]["level"+i+""][j];
							var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
							optlevel.innerHTML = "Display "+valCam+" Level";
							optlevel.value = i+"."+j;
							levelId.appendChild(optlevel);
						}
					}else{
						var optlevel = document.createElement('option');
						var valCh = levelsData[key]["level"+i+""];
						var valCam = valCh.toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						optlevel.innerHTML = "Display "+valCam+" Level";
						optlevel.value = i;
						levelId.appendChild(optlevel);
					}
				}
			}
			break;
		}
	}
	// year load
	var optyear = document.createElement('option');
	optyear.innerHTML = 2011;
	optyear.value = 2011;
	yearId.appendChild(optyear);
	//	
	document.getElementById('level_1_Id').value = level1_Id;
	document.getElementById('levelId').value = levelid;
	document.getElementById('yearId').value = yearid;
	var yearval = document.getElementById("yearId").value;

	$("#level_1_Id").data("selectBox-selectBoxIt").add();
	$("#levelId").data("selectBox-selectBoxIt").add();
	

	/*colors = generic_color = colorbrewer.Blues[5].map(function(rgb) {//.reverse()
		return d3.hsl(rgb);
	});*/

	
	//fieldChange(fieldval);
	

	}

}

function loadData(){

	var prms = $.deparam.fragment();

	if(Object.keys(prms).length > 0){
		var level0_Id = prms.level0;
		var level1_Id = prms.level1;
		var levelid = prms.level;
		var yearid = prms.year;

		var fromDate = prms.frmdate;
		var toDate = prms.todate;
		var dateType = prms.type;
		fieldval = prms.field;
		fieldid_prod = prms.product;


		d3.select("#"+fieldval).attr('class','selected');


		if(!fieldid_prod){
			fieldid_prod = Object.keys(myVariablesKeyProductDetails)[0];
			fieldval = myVariablesKeyProductDetails[fieldid_prod]["id"][0];
		}

		if(myVariablesKeyProductDetails){
		    	if(myVariablesKeyProductDetails[fieldid_prod]){	
				if(myVariablesKeyProductDetails[fieldid_prod].datetype.length > 0){
					if(!dateType){
						dateType = myVariablesKeyProductDetails[fieldid_prod].datetype[0];
					}
				}
			}
		}

		newFunc(fieldval, dateType);
	
		if(myVariablesKeyProductDetails){
		    	if(myVariablesKeyProductDetails[fieldid_prod]){	
				if(myVariablesKeyProductDetails[fieldid_prod].datetype.length > 0){

					if(( $.inArray(dateType, myVariablesKeyProductDetails[fieldid_prod].datetype) != -1)){	

						document.getElementById("time_type").value = dateType;
						$("#time_type").data("selectBox-selectBoxIt").add();							
						if(dateType == "Month"){
							var spltFrmDate = fromDate.split('-');
							var spltToDate = toDate.split('-');
							document.getElementById("frm_time_type_month").value = spltFrmDate[1];
							document.getElementById("to_time_type_month").value =spltToDate[1];
							document.getElementById("frm_time_type_year").value =spltFrmDate[0];
							document.getElementById("to_time_type_year").value =spltToDate[0];

							$("#frm_time_type_month").data("selectBox-selectBoxIt").add();
							$("#to_time_type_month").data("selectBox-selectBoxIt").add();
						}

						if(dateType == "Year"){
							document.getElementById("frm_time_type_year").value =fromDate;
							document.getElementById("to_time_type_year").value =toDate;
						}
						$("#to_time_type_year").data("selectBox-selectBoxIt").add();
						$("#frm_time_type_year").data("selectBox-selectBoxIt").add();
					}			
				}
			}
		}

	applyData();
	}

}

function removeSVG(){
	d3.selectAll('#histogramSvgId').remove();
	d3.selectAll('#histogramOutSvgId').remove();
	d3.select("#map").selectAll('.legend').remove();
	d3.selectAll('#svg_id').remove();
	d3.selectAll('#bar1').remove();
	d3.selectAll('.bar1').remove();
	d3.selectAll('.nomap').remove();
	d3.select("#map").select('image').remove();
	document.getElementById('fieldDetails').innerHTML="";
	document.getElementById("fieldDetails").style.visibility='hidden'; 
	d3.select("#barBackButton").select('image').remove();
}



var selectedState='';
function level1Change(){

	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	var yearval = document.getElementById('yearId').value;
	if(level1_Id != 0){
    	    removeSVG();
	
	    if(selectedState!=level1_Id){
		//DAni
		var pathname1 = window.location.pathname;
		var prmsDt = $.deparam.fragment();
		var prms ={level0:level0_Id, level1:level1_Id, level:levelval, field:fieldval, year:yearval };//,selected: selectedid }
		var r =$.param.fragment(pathname1 ,prms, 2 );
		$.bbq.pushState(r);
		//DAni
	    }else{
		if(level0_Id != 0 && level1_Id != 0){
		//dataLoad(level0_Id,level1_Id,fieldval,yearval,levelval);
		}
	    }
	    selectedState = level1_Id;
	    /*For mybuilds*/
	    //addToMyBuilds(fieldval);
	}else{
		//removeSVG();
		bootbox.alert("Please select a State.");
		return false;
	}
}


var selectedLevel='';
function levelChange1(){
	removeSVG();


	
	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	if (level0_Id == 0) {
	   bootbox.alert("A Country must be selected for this operation. Please select a Country.");
	   return false;
	}
	if (level1_Id == 0) {
	   bootbox.alert("A State must be selected for this operation. Please select a State.");
	   return false;
	}

	if(selectedLevel!=levelval){
		var pathname1 = window.location.pathname;
		var prmsDt = $.deparam.fragment();
		var prms ={level0:level0_Id, level1:level1_Id, level:levelval, field:fieldval};//,selected: selectedid }
		var r =$.param.fragment(pathname1 ,prms, 2 );
		$.bbq.pushState(r);
	}else{
		if(level0_Id != 0 && level1_Id != 0){
		//dataLoad(level0_Id,level1_Id,fieldval,yearval,levelval);
		}
	}
	selectedLevel = levelval;
	//addToMyBuilds(fieldval);
}
function levelChange(){

	removeSVG();
	document.getElementById('normalizeId').checked = false;

	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	var yearval = document.getElementById('yearId').value;
	if (level0_Id == 0) {
	   bootbox.alert("A Country must be selected for this operation. Please select a Country.");
	   return false;
	}
	if (level1_Id == 0) {
	   bootbox.alert("A State must be selected for this operation. Please select a State.");
	   return false;
	}
	/* myvariable */
	var myVariableContent = '';
	var fieldArr = [];
	var fieldArrOvAll = [];
	for(var i=0;i<selectedVariable.length;i++){
		fieldArrOvAll.push(selectedVariable[i]);
	}

	var myVarIndex = "";
	if(typeof(myVariables) == "object"){
		myVarIndex = Object.keys(myVariables);
	}

	if(levelval == 3){
       		fieldval = fieldval.replace('l2','l3');
	}
	if(levelval == 2){
       		fieldval = fieldval.replace('l3','l2');
	}
	/*myVariable */
	for(var i=0;i<selectedMyVariable.length;i++){
		var insideLevel = 0;
		for(var index in  myVarIndex){
			for(var	 keys in myVariables[myVarIndex[index]]){
				if(keys != "levelsmapping"){
					var levelVarArr = myVariables[myVarIndex[index]]['levelsmapping']['level'+levelval];
					for(var keyOfNumber in Object.keys(myVariables[myVarIndex[index]][keys])){
						if(myVariables[myVarIndex[index]][keys][keyOfNumber].id == selectedMyVariable[i] ){
							var myVariableName = myVariables[myVarIndex[index]][keys][keyOfNumber].name;
							//var myVarName=selectedMyVariable[i].replace(/_/g," ").toTitleCase();//.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
							if((( $.inArray(selectedMyVariable[i], levelVarArr)) != -1)){
								fieldArr.push(selectedMyVariable[i]);
								insideLevel = 1;
								if(fieldval == selectedMyVariable[i]){
									myVariableContent+='<li class="selected" id="'+selectedMyVariable[i]+'"><a  data-tooltip="list-item-'+selectedMyVariable[i]+'" data-tooltip2="st-arrow"  class="popup-label" onclick="fieldChange('+"'"+selectedMyVariable[i]+"'"+')" >'+myVariableName+'</a></li>';
								} else {
									myVariableContent+='<li class="" id="'+selectedMyVariable[i]+'"><a  data-tooltip="list-item-'+selectedMyVariable[i]+'" data-tooltip2="st-arrow"  class="popup-label" onclick="fieldChange('+"'"+selectedMyVariable[i]+"'"+')" >'+myVariableName+'</a></li>';
								}
							}
							if(( $.inArray(selectedMyVariable[i], fieldArrOvAll) == -1)){
								fieldArrOvAll.push(selectedMyVariable[i]);
							}
						}
					}
				}	
			}	
		}
		if(insideLevel == 0){
			myVariableContent+='<li class="" id="'+selectedMyVariable[i]+'"><a  data-tooltip="list-item-'+selectedMyVariable[i]+'" data-tooltip2="st-arrow" style="color:#C0C0C0 ;disable:true;"  class="popup-label" >'+myVariableName+'</a></li>';
		}
	}
	var fieldNotFound = 0;
	if(myVariableContent.length > 1){	
		document.getElementById('myVariableListId').innerHTML=myVariableContent;
	}else{
		document.getElementById('myVariableListId').innerHTML="";
	}

	if(( $.inArray(fieldval, fieldArrOvAll) == -1)){
		fieldNotFound = 1;	
	}
	
	/* to clear all selected color and re color the selected variable*/
	for(var i=0;i<selectedVariable.length;i++){
		d3.select("#"+selectedVariable[i]).attr('class','');	 
	}
	d3.select("#"+fieldval).attr('class','selected');

	if(selectedLevel!=levelval){
		var pathname1 = window.location.pathname;
		var prmsDt = $.deparam.fragment();
		var prms ={level0:level0_Id, level1:level1_Id, level:levelval, field:fieldval};//,selected: selectedid }
		var r =$.param.fragment(pathname1 ,prms, 2 );
		$.bbq.pushState(r);
	}else{
		if(level0_Id != 0 && level1_Id != 0){
		//dataLoad(level0_Id,level1_Id,fieldval,yearval,levelval);
		}
	}

	selectedLevel = levelval;
	addToMyBuilds(fieldval);
}


function addToMyBuilds(fieldid){
	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	mysphere_url_list="/app/mysphere_mybuilds_for_region_trend/"+level1_Id+"?level0="+level0_Id+"&level="
				+levelval+"&region_key="+fieldid+"&selectedvariables="+JSON.stringify(selectedVariable)
				+"&selectedMyVariableProd="+JSON.stringify(selectedMyVariableProd)+"";
	d3.json(mysphere_url_list,function(data){
		var str = JSON.stringify(data.MyBuild[0])
		var newvar = JSON.parse(str);
	});
}



var colors;
var fieldval;
var fieldid_prod = "";
var selectedField='';
var selectedYear='';
selectedMyVariableProd= ["pv_16_3", "pv_18_13"] ;
function fieldChange(fieldid){
	
	document.getElementById('normalizeId').checked = false;
	for(var keys in myVariablesKeyProductDetails){
		if(( $.inArray(fieldid, myVariablesKeyProductDetails[keys]["id"]) !=  -1)){	
			fieldid_prod = keys;
		}
	}

	fieldval = fieldid;
	for(var i=0;i<selectedVariable.length;i++){
		d3.select("#"+selectedVariable[i]).attr('class','');	 
	}

	for(var i=0;i<selectedMyVariable.length;i++){
		var selectedMyVariableId = selectedMyVariable[i];
		var re = new RegExp(" ", 'g');
		selectedMyVariableId = selectedMyVariableId.replace(re, '_');
		d3.select("#"+selectedMyVariableId).attr('class','');
		if(fieldid == selectedMyVariableId){
			fieldval = selectedMyVariable[i];
		}
	}	
	for(var i=0;i<selectedMyVariableProd.length;i++){
		var selectedMyVariableId = selectedMyVariableProd[i];
		var re = new RegExp(" ", 'g');
		selectedMyVariableId = selectedMyVariableId.replace(re, '_');
		d3.select("#"+selectedMyVariableId).attr('class','');
		if(fieldid == selectedMyVariableId){
			fieldval = selectedMyVariableProd[i];
		}
	}

	d3.select("#"+fieldid).attr('class','selected');

	removeSVG();
	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	var yearval = document.getElementById('yearId').value;
	if (level0_Id == 0) {
	   bootbox.alert("A Country must be selected for this operation. Please select a Country.");
	   return false;
	}
	if (level1_Id == 0) {
	   bootbox.alert("A State must be selected for this operation. Please select a State.");
	   return false;
	}

	selectedField = fieldval;
	selectedYear = yearval;

	newFunc(fieldid,'');
	applyData();

}


// level2 variables
var maxvall, minvalue, minvalue, secval, midval, midval1, forval, maxvall, rawData,l2_Data,l3_Data;
var yearVal, KeyVal, level_2;

// level3 variables
var l3_RawData,l3_KeyVal,l3_YearVal,l3_level_3,l3_level_2;
var masterData = new Array(4);
var canvasImage;
var monthObj={
	"01":"Jan",
	"02":"Feb",
	"03":"Mar",
	"04":"Apr",
	"05":"May",
	"06":"Jun",
	"07":"Jul",
	"08":"Aug",
	"09":"Sep",
	"10":"Oct",
	"11":"Nov",
	"12":"Dec"	
 };


var yrObj=["2015","2014","2013","2012","2011","2010","2009","2008"];
var monthArr=["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];


var to_time_id_test = document.getElementById('to_time_id_test');
var to_time_id = document.getElementById('to_time_id');
var from_time_id = document.getElementById('from_time_id');
var time_type = document.getElementById('time_type');


function newFunc(fieldid,type){

	var prodKeys = 0;
	for(var keys in myVariablesKeyProductDetails){
		if(( $.inArray(fieldid, myVariablesKeyProductDetails[keys]["id"]) !=  -1)){	
			fieldid_prod = keys;
			prodKeys = 1;
		}
	}
	
	if(prodKeys == 0){
		fieldid_prod = Object.keys(myVariablesKeyProductDetails)[0];
	}

	fieldvalProd = fieldid_prod;

	$('#time_type').html="";
	$("#time_type").data("selectBox-selectBoxIt").remove();

	var timeContent = "";
	var timeType="";
	
	if(type == ""){
		if(myVariablesKeyProductDetails){
			if(myVariablesKeyProductDetails[fieldid_prod]){
				if(myVariablesKeyProductDetails[fieldid_prod].datetype){
					if(myVariablesKeyProductDetails[fieldid_prod].datetype[0]){
						timeType = myVariablesKeyProductDetails[fieldid_prod].datetype[0];		
					}
				}
			}
		}
	}else{
		timeType = type;
	}

	if(timeType =='Month' ){
		timeContent = '<div id="from_date"  class="select-wrap1"><table width="350px;" > <tr> <td>  From: '+
				    '</td>  <td style="width:65px;"> '+
				     ' <select id="frm_time_type_month" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td> <td >'+
				      '<select id="frm_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td>   <td style="width:35px;height:35px;">To: '+
				    '</td>  <td>'+
				      '<select id="to_time_type_month" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td> <td>'+
				      '<select id="to_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td> </tr>  </table></div>';
	}

	if(timeType =='Year' ){
		timeContent = '<div id="from_date"  class="select-wrap1"><table width="300px;" > <tr> <td>  From: '+
				    '</td>  <td> '+
				      '<select id="frm_time_type_year" class="custom_selectbox" style="width:100px;"></select>'+
				    '</td>  <td >To: </td>  <td > '+
				      '<select id="to_time_type_year" class="custom_selectbox" style="width:100px;"></select>'+
				    '</td> </tr>  </table></div>';
	}	
	
	document.getElementById('time_from_to').innerHTML = timeContent;

	var frmTimeMnthId = document.getElementById('frm_time_type_month');
	var frmTimeYrId = document.getElementById('frm_time_type_year');
	var toTimeMnthId = document.getElementById('to_time_type_month');
	var toTimeYrId = document.getElementById('to_time_type_year');


	var kys = Object.keys(myVariablesKeyProductDetails);
	var yr = [];
	var mn = [];

	for (var yearVal in myVariablesKeyProductDetails[fieldid_prod].year){
		if(( $.inArray(myVariablesKeyProductDetails[fieldid_prod].year[yearVal], yr ) ==  -1)){
			yr.push(myVariablesKeyProductDetails[fieldid_prod].year[yearVal]);
		}
	}
	for (var monthVal in myVariablesKeyProductDetails[fieldid_prod].month){
		if(( $.inArray(myVariablesKeyProductDetails[fieldid_prod].month[monthVal], mn ) ==  -1)){
			mn.push(myVariablesKeyProductDetails[fieldid_prod].month[monthVal]);
		}
	}

	/*for(var j=0;j<myVariablesDateType.length;j++){				
		var dateType = document.createElement('option');
		dateType.innerHTML = myVariablesDateType[j];
		dateType.value = myVariablesDateType[j];
		time_type.appendChild(dateType);
	}*/

	$("#time_type").data("selectBox-selectBoxIt").remove();
	for(var j=0;j<myVariablesKeyProductDetails[fieldid_prod].datetype.length;j++){				
		var dateType = document.createElement('option');
		dateType.innerHTML = myVariablesKeyProductDetails[fieldid_prod].datetype[j];
		dateType.value = myVariablesKeyProductDetails[fieldid_prod].datetype[j];
		time_type.appendChild(dateType);
	}

	$("#time_type").data("selectBox-selectBoxIt").add();

	if(timeType =='Year' ){

		$("#to_time_type_year").html("");
		$("#frm_time_type_year").html("");
		
		var minYr = d3.min(yr, function(d) {return d;});
		var maxYr = d3.max(yr, function(d) {return d;});

		for(var j=0;j<yrObj.length;j++){				
			var fromYr = document.createElement('option');
			fromYr.innerHTML = yrObj[j];
			fromYr.value = yrObj[j];
			frmTimeYrId.appendChild(fromYr);
		}
		for(var j=0;j<yrObj.length;j++){				
			var toYr = document.createElement('option');
			toYr.innerHTML = yrObj[j];
			toYr.value = yrObj[j];
			toTimeYrId.appendChild(toYr);
		}	
		//$("#to_time_type_year").val(maxYr);
		//$("#from_time_type_year").val(minYr);
		document.getElementById('to_time_type_year').value = maxYr;
		document.getElementById('frm_time_type_year').value = minYr;

	
	}
	if(timeType =='Month' ){

		$("#to_time_type_year").html("");
		$("#to_time_type_month").html("");
		$("#frm_time_type_year").html("");		
		$("#frm_time_type_month").html("");		

		var minYr = d3.min(yr, function(d) {return d;});
		var maxYr = d3.max(yr, function(d) {return d;});
		var minMn = d3.min(mn, function(d) {return d;});
		var maxMn = d3.max(mn, function(d) {return d;});

		
		for(var j=0;j<yrObj.length;j++){				
			var fromYr = document.createElement('option');
			fromYr.innerHTML = yrObj[j];
			fromYr.value = yrObj[j];
			frmTimeYrId.appendChild(fromYr);
		}
		for(var k=0;k<yrObj.length;k++){				
			var toYr = document.createElement('option');
			toYr.innerHTML = yrObj[k];
			toYr.value = yrObj[k];
			toTimeYrId.appendChild(toYr);
		}

		for(var j=0;j<monthArr.length;j++){
			var fromMn = document.createElement('option');
			fromMn.innerHTML = monthObj[monthArr[j]];
			fromMn.value = monthArr[j];
			frmTimeMnthId.appendChild(fromMn);
		}
		for(var j=0;j<monthArr.length;j++){				
			var toMn = document.createElement('option');
			toMn.innerHTML = monthObj[monthArr[j]];
			toMn.value = monthArr[j];
			toTimeMnthId.appendChild(toMn);
		}	
		$("#to_time_type_year").val(maxYr);
		$("#frm_time_type_year").val(minYr);
		$("#to_time_type_month").val(maxMn);
		$("#frm_time_type_month").val(minMn);
	
		document.getElementById('to_time_type_month').value = maxMn;
		document.getElementById('frm_time_type_month').value = minMn;
		document.getElementById('to_time_type_year').value = maxYr;
		document.getElementById('frm_time_type_year').value = minYr;

	}
 	$('.custom_selectbox').selectBoxIt({ defaultText: '', autoWidth: false });

	//hashUpdate();
}


function hashUpdate(){

	var fieldid_prod = fieldval;

	for(var keys in myVariablesKeyProductDetails){
		if(( $.inArray(fieldval, myVariablesKeyProductDetails[keys]["id"]) !=  -1)){	
			fieldid_prod = keys;
		}else if(fieldval == keys){
			fieldid_prod = fieldval;
		}
	}

	var level0_Id = document.getElementById('level_0_Id').value;
	var level1_Id = document.getElementById('level_1_Id').value;
	var levelval = document.getElementById('levelId').value;
	var yearval = document.getElementById('yearId').value;

	var timeTtype= document.getElementById("time_type").value;
	var frmMonth ="";
	var toMonth ="";
	var frmYear ="";	
	var toYear ="";

	if(document.getElementById("frm_time_type_month")){
		frmMonth= document.getElementById("frm_time_type_month").value;
		toMonth= document.getElementById("to_time_type_month").value;
	}
	if(document.getElementById("frm_time_type_year")){
		frmYear= document.getElementById("frm_time_type_year").value;
		toYear= document.getElementById("to_time_type_year").value;
	}

	var fromDate ="", toDate="";
	
	if(timeTtype =="Month"){
		fromDate = frmYear+"-"+frmMonth;
		toDate = toYear+"-"+toMonth;
	}else{
		fromDate = frmYear;
		toDate = toYear;
	}

	var pathname1 = window.location.pathname;
	var prmsDt = $.deparam.fragment();
	var prms ={level0:level0_Id, level1:level1_Id, level:levelval, field:fieldval, product:fieldid_prod, type:timeTtype, frmdate: fromDate, todate: toDate};//,selected: selectedid }
	var r =$.param.fragment(pathname1 ,prms, 2 );
	$.bbq.pushState(r);
	

}

function timeTypeChange(){
	var time_type_value = document.getElementById('time_type').value;	
	document.getElementById('time_from_to').innerHTML = "";


	var timeContent ="";
	if(time_type_value=="Month"){

		timeContent = '<div id="from_date"  class="select-wrap1"><table width="350px;" > <tr> <td>  From: '+
				    '</td><td> '+
				     ' <select id="frm_time_type_month" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td><td>'+
				      '<select id="frm_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td><td style="width:35px;height:35px;">To: '+
				    '</td><td >'+
				      '<select id="to_time_type_month" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td><td>'+
				      '<select id="to_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td></tr></table></div>';

	}
	if(time_type_value=="Year"){

		timeContent = '<div id="from_date"  class="select-wrap1"><table width="250px;" > <tr> <td>  From: '+
				    '</td><td> '+
				      '<select id="frm_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td><td >To: '+
				    '</td><td>'+
				      '<select id="to_time_type_year" class="custom_selectbox" style="width:150px;"></select>'+
				    '</td></tr></table></div>';

	}	
	
	document.getElementById('time_from_to').innerHTML = timeContent;

	var frmTimeMnthId = document.getElementById('frm_time_type_month');
	var frmTimeYrId = document.getElementById('frm_time_type_year');
	var toTimeMnthId = document.getElementById('to_time_type_month');
	var toTimeYrId = document.getElementById('to_time_type_year');


	var kys = Object.keys(myVariablesKeyProductDetails);
	var yr = [];
	var mn = [];

	for (var yearVal in myVariablesKeyProductDetails[fieldid_prod].year){
		if(( $.inArray(myVariablesKeyProductDetails[fieldid_prod].year[yearVal], yr ) ==  -1)){
			yr.push(myVariablesKeyProductDetails[fieldid_prod].year[yearVal]);
		}
	}
	for (var monthVal in myVariablesKeyProductDetails[fieldid_prod].month){
		if(( $.inArray(myVariablesKeyProductDetails[fieldid_prod].month[monthVal], mn ) ==  -1)){
			mn.push(myVariablesKeyProductDetails[fieldid_prod].month[monthVal]);
		}
	}

	if(time_type_value=="Year"){
		$("#to_time_type_year").html("");
		$("#frm_time_type_year").html("");

		var minYr = d3.min(yr, function(d) {return d;});
		var maxYr = d3.max(yr, function(d) {return d;});		

		for(var j=0;j<yrObj.length;j++){				
			var fromYr = document.createElement('option');
			fromYr.innerHTML = yrObj[j];
			fromYr.value = yrObj[j];
			frmTimeYrId.appendChild(fromYr);
		}
		for(var j=0;j<yrObj.length;j++){				
			var toYr = document.createElement('option');
			toYr.innerHTML = yrObj[j];
			toYr.value = yrObj[j];
			toTimeYrId.appendChild(toYr);
		}	
		$("#to_time_type_year").val(maxYr);
		$("#frm_time_type_year").val(minYr);
	
	}
	if(time_type_value=="Month"){
		$("#to_time_type_year").html("");
		$("#to_time_type_month").html("");
		$("#frm_time_type_year").html("");		
		$("#frm_time_type_month").html("");	

		var minYr = d3.min(yr, function(d) {return d;});
		var maxYr = d3.max(yr, function(d) {return d;});
		var minMn = d3.min(mn, function(d) {return d;});
		var maxMn = d3.max(mn, function(d) {return d;});
	

		for(var j=0;j<yrObj.length;j++){				
			var fromYr = document.createElement('option');
			fromYr.innerHTML = yrObj[j];
			fromYr.value = yrObj[j];
			frmTimeYrId.appendChild(fromYr);
		}
		for(var j=0;j<yrObj.length;j++){				
			var toYr = document.createElement('option');
			toYr.innerHTML = yrObj[j];
			toYr.value = yrObj[j];
			toTimeYrId.appendChild(toYr);
		}

		for(var j=0;j<monthArr.length;j++){				
			var fromMn = document.createElement('option');
			fromMn.innerHTML = monthObj[monthArr[j]];
			fromMn.value = monthArr[j];
			frmTimeMnthId.appendChild(fromMn);
		}
		for(var j=0;j<monthArr.length;j++){				
			var toMn = document.createElement('option');
			toMn.innerHTML = monthObj[monthArr[j]];
			toMn.value = monthArr[j];
			toTimeMnthId.appendChild(toMn);
		}	

		$("#to_time_type_year").val(maxYr);
		$("#frm_time_type_year").val(minYr);
		$("#to_time_type_month").val(maxMn);
		$("#frm_time_type_month").val(minMn);

	}

	$('.custom_selectbox').selectBoxIt({ defaultText: '', autoWidth: false });
	
	hashUpdate();
}

var tempData_new = [];
var parseDate = '';
function applyData(){
	$("#line").empty();
	var level1_Id = document.getElementById('level_1_Id').value; 
	var levelId = document.getElementById('levelId').value; 
 	var time_type_value = document.getElementById('time_type').value;
	var dateTimeFrm = "";
	var dateTimeTo = "";
	if (time_type_value =="Year"){
		parseDate = d3.time.format("%Y").parse;
		var frm_time_type_year = document.getElementById("frm_time_type_year").value;
		var to_time_type_year = document.getElementById("to_time_type_year").value;
		dateTimeFrm = frm_time_type_year;
		dateTimeTo = to_time_type_year;
	}	
	if (time_type_value =="Month"){
		parseDate = d3.time.format("%Y-%m").parse;
		var frm_time_type_month = document.getElementById("frm_time_type_month").value;
		var to_time_type_month = document.getElementById("to_time_type_month").value;
		var frm_time_type_year = document.getElementById("frm_time_type_year").value;
		var to_time_type_year = document.getElementById("to_time_type_year").value;

		dateTimeFrm = frm_time_type_year+'-'+frm_time_type_month;
		dateTimeTo = to_time_type_year+'-'+to_time_type_month;
	}	


	var nameOfVar = myVariablesKeyProductDetails[fieldid_prod].keyname
	document.getElementById('spacialcontent').innerHTML=nameOfVar;

	trendData = [];
	tempData_new = [];
	normalizedTrendData = [];
	d3.json("/app/scisphere/places/trend_data/"+level1_Id+"?key="+fieldid_prod+"&myloc="+orgid+"&level="+levelId+"&from="+dateTimeFrm+"&to="+dateTimeTo+"&type="+time_type_value.toLowerCase()+"",function(data){

		console.log(data);
		if(data){
			if(data.Message || data.message){
				$("#line").empty();
				var maploading = d3.select("#line").append("svg").attr("class", "no_data").attr("width", 420)
								.attr("height", 300).attr("transform", "translate(100, 120 )scale(1.8)");
					maploading.append("text").attr("x", 308).attr("y", 113) 
					.text("No data found");
				return false;
			}
		}

		for(var i=0; i<data.length; i++ ){
			if(data[i]){
				if(data[i]._source){
					if(data[i]._source.key.indexOf("sum_by") > -1){
						data[i]._source['place_name'] = data[i]._source['name_'+levelId+''];
						tempData_new.push(data[i]._source);
						trendData.push(data[i]._source);
					}
				}
			}
		}
	
		trendData = trendData.sort(function(a,b) { return d3.ascending(a.date, b.date); });
		var tempData = [];
		var minval = d3.min(trendData, function(d) {return +d.value;});
		var maxval = d3.max(trendData, function(d) {return +d.value;});
		dataLoad();

		function dataLoad(){
			for(var i=0; i<trendData.length; i++ ){
				var arr = Object.keys(trendData[i]);
				var obj = {};	
				for(var j=0; j<arr.length; j++){
					if(arr[j] === "value"){
						obj[arr[j]] = trendData[i][arr[j]]/minval;
					}else{
						obj[arr[j]] = trendData[i][arr[j]]
					}
				}
				if(Object.keys(obj).length > 0){
					normalizedTrendData.push(obj);
				}
			}
		}


		trendData = trendData.sort(function(a,b) { return d3.ascending(a.date, b.date); });

		document.getElementById('line').innerHTML="";
		document.getElementById('sales-perfomance1').innerHTML="";

		chart1.configGPL.unit.guide.y.label = nameOfVar;
		chart1.configGPL.unit.guide.x.label = time_type_value;
		chart1.setData(trendData);

	});

	hashUpdate();

}


function yaxisChange(d){

	tempData_new = tempData_new.sort(function(a,b) { return d3.ascending(a.date, b.date); });
	normalizedTrendData = normalizedTrendData.sort(function(a,b) { return d3.ascending(a.date, b.date); });

	if($("#normalizeId").prop('checked') == true){
		chart1.setData(normalizedTrendData);
		//chart2.setData(normalizedTrendData);
	} else {
		chart1.setData(tempData_new);
		//chart2.setData(trendData);
	}
}

function chartChange(){
	setTimeout(function() {
		chart1.setData(trendData);
		chart2.setData(trendData);
            }, 0);
}


function valueRound(d , numberFormat_form , j){
	var numberFormat = d3.format(".0f");
	numberFormat = numberFormat_form;
	var numberFormat1 = d3.format(".0f");
	var numberFormatValue=0;
	var i = j;
	var val1 = (numberFormat1((numberFormat1(d)))).length;
		    var val = (numberFormat1((numberFormat1(d))));
		    var Value;
		    if ((val1 > 0) && (val1 <= 3)) {
			if(i==0){
				Value = (numberFormat(d) + "  +");
			}else{
				Value = (numberFormat(d) + " ");
				}
		    }
		    if ((val1 > 3) && (val1 <= 6)) {
			finalValue = val / 1000;
			if(i==0){
				Value = (numberFormat(finalValue) + " K  +");
			}else{
				Value = (numberFormat(finalValue) + " K");
				}

		    }
		    if ((val1 > 6) && (val1 <= 9)) {
			finalValue = val / 1000000;
			if(i==0){
				Value = (numberFormat(finalValue) + " M  +");
			}else{
				Value = (numberFormat(finalValue) + " M");
				}
		    }
		    if (val1 > 9) {
			finalValue = val / 1000000000;
			if(i==0){
				Value = (numberFormat(finalValue) + " B  +");
			}else{
				Value = (numberFormat(finalValue) + " B");
				}
		    }
	return Value;
}


// using ajax form submission
$(document).ready(function() {

    // prepare Options Object for plugin
    var options = {
        success: function() {
	    $('.close').click();
            $("#form_ajax").show();
            setTimeout(function() {
                $("#form_ajax").hide();
            }, 5000);
        },
        error:  function(resp) {
	    $('.close').click();
            $("#form_ajax_error").show();
            //render errors in form fields
            var errors = JSON.parse(resp.responseText);
            for (error in errors) {
                var id = '#id_' + error;
                $(id).parent('p').prepend(errors[error]);
            }
            setTimeout(function() {
                $("#form_ajax_error").hide();
            }, 5000);
        }
    };
    $('#ajaxform').ajaxForm(options);
    //$('#ajaxformUrlShare').ajaxForm(options);

});

function contextClick(){
	cancelSelection();
	d3.select("#pop-geo").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-myvar").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-contextual").attr("class","pop-acc-content clearfix collapse in ").attr("style","");
}

function geoClick(){
	cancelSelection();
	d3.select("#pop-contextual").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-myvar").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-geo").attr("class","pop-acc-content clearfix collapse in ").attr("style","");
}

function myVarClick(){
	cancelSelection();
	d3.select("#pop-geo").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-contextual").attr("class","collapse pop-acc-content clearfix").attr("style","");
	d3.select("#pop-myvar").attr("class","pop-acc-content clearfix collapse in ").attr("style","");
}

function helpChange(selected){
	var innerhtml_graph = '<a class="help" data-toggle="tooltip" data-placement="left" data-popover="true" data-html=true data-content="Region allows you to compare a set of contiguous regions within a selected geography along a selected dimension.For example, compare all Districts within a State or all Taluks within a District by Population. <br><br>'+ 
				'To add or change contextual variables in the list available in the menu,<br> click the + button next to Contextual variables.<br><br>'+
				'<strong>Choropleth Map</strong><br><br>'+
				'&nbsp;&nbsp;The color of the sub-region represents its value. You can:<br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Hover over an area to see its name and value. <br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Right click to see a snapshot of the sub-region across the contextual variables in your list.<br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Click on a sub-region to drill down to the next level.  <br><br>'+
				'<strong>Bar Graphs</strong><br><br>'+
				'In this view each bar represents a sub-region of the overall selection. '+
				' Hover over the bar to see the name of the place and its value." id="help"></a>';

	var innerhtml_histogram = '<a class="help" data-toggle="tooltip" data-placement="left" data-popover="true" data-html=true data-content="Region allows you to compare a set of contiguous regions within a selected geography along a selected dimension.For example, compare all Districts within a State or all Taluks within a District by Population. <br><br>'+ 
				'To add or change contextual variables in the list available in the left menu, '+
				'click the + button next to Contextual variables.<br><br>'+
				'<strong>Choropleth Map</strong><br><br>'+
				'&nbsp;&nbsp;The color of the sub-region represents its value. You can:<br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Hover over an area to see its name and value. <br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Right click to see a snapshot of the sub-region across the contextual variables in your list.<br>'+
				'&nbsp;&nbsp;<strong>*</strong>&nbsp;&nbsp;Click on a sub-region to drill down to the next level.  <br><br>'+
				'<strong>Histogram</strong><br><br>'+
				'This view counts up the sub-regions into ranges specified on the x-axis.  Outliers are shown separately for better resolution of the bulk data distribution. '+
				'Mean (average), Median (50th percentile of all values), and the fold difference between the 75th and 25th percentile values and 90th and 10th percentile values are shown below the histogram." id="help"></a>';

	if(selected === "Bar"){
		document.getElementById('help-popover').innerHTML = innerhtml_graph;
	}else{
		document.getElementById('help-popover').innerHTML = innerhtml_histogram;
	}

}


// session Timeout set and redirect
var wintimeout;
function SetWinTimeout() {
	wintimeout = window.setTimeout("window.location.href='/accounts/logout/';",3600000); //after 5 mins i.e. 5 * 60 * 1000
}
$(document).ready(function(){
	$('body').click(function() {
		window.clearTimeout(wintimeout); //when user clicks remove timeout and reset it
		SetWinTimeout();
	});
});
SetWinTimeout();

